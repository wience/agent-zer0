{
  "title": "/v1/payments/pay",
  "content": "# /v1/payments/pay\n\n2022-07-03 18:44\n\nPOST `/v1/payments/pay`\n\nThe `pay` API is used to initiate a payment at wallet.\n\n**Note:** A payment which takes place at _wallet._\n\n1）merchant/partner initiates payment request to _wallet_ through Payment Interface.\n\n2）Wallet will handle different payment scenarios base on the parameters in request.\n\nCurrently, payment API support following acquiring scenarios:\n\n- Cashier Payment：Usually used in online payment scenario. In this scenario, merchant/partner will call this payment API to create order, and wallet will return cashier page url to merchant/partner, and then redirect to this cashier page. So user can finished payment in cashier page.\n\n# Message structure\n\n## Request\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n| **Property** | **Data type** | **Required** | **Description** |\n| partnerId | String | Yes | The partnerId allocated by wallet.<br>Max. length: 32 characters. |\n| appId | String | Yes | The mini program ID.<br>Max. length: 32 characters. |\n| productCode | String | No | Defined by wallet, wallet will use productCode to get the contract config which include fee,limit info.<br>Max. length: 32 characters. |\n| paymentOrderTitle | String | Yes | The order title of this payment.<br>Max. length: 256 characters. |\n| paymentRequestId | String | Yes | The unique ID of a payment generated by merchant.<br>- Max. length: 64 characters.<br>- This field is used for the [idempotence](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/api_idempotency) control. For the payment requests which are initiated with the same `paymentRequestId` and reach a final status (S or F),  the wallet must return the unique result. |\n| paymentAmount | [**Amount**](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/vs3pkf#2umUE) | Yes | Order amount for display of user consumption records, payment results page. |\n| paymentMethods | [**PaymentMethod**](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/vs3pkf#oyGqE) | No | The paymentMethod used to collect fund by wallet. |\n| paymentAuthCode | String | No | If payFactor.isAgreementPay is true,then it's the accessToken of wallet user, if payFactor.isPaymentCode is true, then it's the authcode of wallet user.<br>Max. length: 128 characters. |\n| paymentFactor | [**PaymentFactor**](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/vs3pkf#4Xo31) | No | In the Mini Program scenario, it is fixed value, map format, {\"isCashierPayment\" : true}. |\n| paymentExpiryTime | String/Datetime | No | The payment order close time defined by merchant, which follows the [ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html) standard. |\n| paymentReturnUrl | String | No | The redirect url defined by merchan.<br>Max. length: 1024 characters. |\n| paymentNotifyUrl | String | No | The payment success notify url defined by merchant.<br>Max. length: 1024 characters. |\n| mcc | String | No | The merchant category code.<br>Max. length: 32 characters. |\n| extraParams | Map | No | Map format, specific payment ability which provided by wallet, now we only support 1 key : ORDER. |\n| extendInfo | String | No | The extend information,wallet and merchant can put extend info here.<br>Max. length: 4096 characters. |\n| envInfo | [**EnvInfo**](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/vs3pkf#8vntm) | No | Environment information of mobile phone. |\n\n## Response\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n| **Property** | **Data type** | **Required** | **Description** |\n| result | [**Result**](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/vs3pkf#sHXZc) | Yes | The request result, which contains information related to the request result, such as status and error codes. |\n| paymentId | String | No | The unique ID of a payment generated by Wallet.<br>Max. length: 64 characters. |\n| paymentTime | String/Datetime | No | Payment success time, which follows the [ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html) standard. |\n| actionForm | [**ActionForm**](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/vs3pkf#Idyhx) | No |  |\n| authExpiryTime | String/Datetime | No | Authorization expiry time, has value only when paymentFactor.isAuthorizationPayment is true. |\n| extendInfo | String | No | The extend information,wallet and merchant can put extend info here.<br>Max. length: 4096 characters. |\n\n### Result process logic\n\nFor different request results, different actions are to be performed. See the following list for details:\n\n- **result.resultStatus = S**\n\n- That means this transaction is success, merchant/partner can update transaction to success. What need to notice is :\n\n- In payment evaluation scenario, 'S' just means evaluate success, no real fund transfer.\n- In authorization payment scenario, 'S' just means authorization success, need wait for capture operation to finish the  transaction(finish final fund flow).\n\n- **result.resultStatus = A**\n\n- That means transaction already accept by wallet. Merchant/partner need continue the next step operation according to actionForm response.  Such as display order code to user or redirect to wallet cashier page.\n\n- **result.resultStatus = F**\n\n- That means this transaction is failed, the failed reason can refer to result code param.  Usually F transactions can not be success again if use the same payment request to call wallet.\n\n- **result.resultStatus = U**\n\n- That means unknown exception occur on wallet side. Merchant/partner can inquiry payment result or waiting for payment status notification to get the real payment result. What need to notice is :\n\n- Payment evaluation scenario can not inquiry.\n- U status can not set to fail or success on merchant/partner system.\n- U status can not refund to user by offline(Maybe will make fund loss).\n\n### Result\n\n|     |     |     |\n| --- | --- | --- |\n| **resultStatus** | **resultCode** | **resultMessage** |\n| S | SUCCESS | Success. |\n| U | UNKNOWN\\_EXCEPTION | An API calling is failed, which is caused by unknown reasons. |\n| U | REQUEST\\_TRAFFIC\\_EXCEED\\_LIMIT | The request traffic exceeds the limit. |\n| U | PAYMENT\\_IN\\_PROCESS | The payment is still under process. |\n| A | ACCEPT | Need next action according to actionForm. |\n| F | REPEAT\\_REQ\\_INCONSISTENT | Repeated submit, and requests are inconsistent. |\n| F | PROCESS\\_FAIL | A general business failure occurred. Don't retry. |\n| F | INVALID\\_API | The called API is invalid or not active. |\n| F | PARAM\\_ILLEGAL | Illegal parameters exist. For example, a non-numeric input, or an invalid date. |\n| F | ACCESS\\_DENIED | The access is denied. |\n| F | PAYMENT\\_AMOUNT\\_EXCEED\\_LIMIT | Payment amount exceeds limit. |\n| F | USER\\_NOT\\_EXIST | User not exist. |\n| F | USER\\_STATUS\\_ABNORMAL | The user status is abnormal. |\n| F | USER\\_BALANCE\\_NOT\\_ENOUGH | User balance is not enough for this payment. |\n| F | PARTNER\\_NOT\\_EXIST | Partner not exist. |\n| F | PARTNER\\_STATUS\\_ABNORMAL | Partner status abnormal. |\n| F | RISK\\_REJECT | Risk reject. |\n| F | CURRENCY\\_NOT\\_SUPPORT | The currency is not supported. |\n| F | ORDER\\_STATUS\\_INVALID | Order is in invalid status such closed. |\n| F | INVALID\\_ACCESS\\_TOKEN | Invalid accesstoken. |\n| F | USER\\_AMOUNT\\_EXCEED\\_LIMIT | Payment amount exceeds user's amount limit. |\n| F | EXPIRED\\_ACCESS\\_TOKEN | The access token is expired. |\n| F | AUTH\\_CODE\\_ALREADY\\_USED | Auth code already used. |\n| F | INVALID\\_CODE | Auth code illegal. |\n| F | EXPIRED\\_AGENT\\_TOKEN | The access token of mini program is expired. |\n| F | INVALID\\_AGENT\\_TOKEN | The access token of mini program is invalid. |\n\n# Sample\n\n## Cashier Payment\n\nFor example, a user purchases a 100 USD merchandise at the merchant/partner(online merchant usually) , merchant/partner call this payment api to create payment order first, wallet will return payment order id and wallet cashier page url to merchant/partner, then merchant/partner can redirect user to wallet cashier page with my.tradePay api.\n\n![/v1/payments/pay](https://ac.alipay.com/storage/2020/5/11/793a3d8d-5270-405b-9362-e6a670b9c842.png)\n\n1. Firstly the Mini Program create order (Step 1).\n2. The merchant server calls /v1/payments/pay interface with paymentNotifyUrl to initiate payment flow (Step 2).\n3. E-wallet server returns payment detail information with paymentId to the merchant server (Step 3).\n4. The merchant server has to pass through the payment detail information to the Mini Program (step 4).\n5. And the Mini Program should call my.tradePay interface to do payment (Step 5).\n6. When the payment reaches the final status, e-wallet server notifies the payment result to the merchant server with paymentNotifyUrl provided in Step 2 (Step 8).\n7. Also E-wallet App returns payment result to the Mini Program (Step 9).\n\n### Request\n\ncopy\n\n```json\n{\n    \"partnerId\": \"P000000000000001xxxx\",\n    \"paymentRequestId\": \"2019112719074101000700000077771xxxx\",\n    \"paymentOrderTitle\": \"SHOES\",\n    \"productCode\": \"PC_5800000001\",\n    \"mcc\": \"4399\",\n    \"paymentAmount\": {\n        \"currency\": \"USD\",\n        \"value\": \"10000\"\n    },\n    \"paymentFactor\": {\n        \"isCashierPayment\": true\n    },\n    \"paymentReturnUrl\":\"https://www.merchant.com/redirectxxx\",\n    \"paymentNotifyUrl\":\"https://www.merchant.com/paymentNotifyxxx\",\n    \"extraParams\": {\n        \"ORDER\": \"{\\\"referenceOrderId\\\":\\\"ID_000001\\\",\\\"orderAmount\\\":\\\"{\\\\\\\"currency\\\\\\\":\\\\\\\"USD\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"10000\\\\\\\"}\\\"}\"\n    },\n    \"extendInfo\": \"{\\\"customerBelongsTo\\\":\\\"siteNameExample\\\"}\",\n    \"envInfo\": {\n        \"osType\": \"IOS\",\n        \"terminalType\": \"APP\"\n    }\n}\n```\n\n- **partnerId** is the identifier of a merchant/partner, allocated by Wallet.\n- **paymentRequestId** is generated by merchant/partner, uniquely identifies the payment. Wallet must make use of paymentRequestId and partnerId for idempotent control. For example, if a payment with paymentRequestId== 2019112719074101000700000077771xxxx and partnerId==P000000000000001xxxx  has been processed successfully by Wallet, when merchant/partneruses the same paymentRequestId  and partnerId for payment, Wallet will respond with successful payment.\n- **productCode** defined by wallet, wallet will use productCode to get the contract config which include fee,limit info.\n- **paymentFactor** In the Mini Program scenario, the **PaymentFactor** only have the fixed value: isCashierPayment = true\n- **paymentReturnUrl** is the url defined by merchant/partner.  In cashier payment scenario, after user finished payment in wallet cashier page, wallet will direct back to merchant base on this URL.\n- **paymentNotifyUrl** is the url defined by merchant/partner.  In cashier payment scenario, after user finished payment in wallet cashier page, wallet will notify merchant the payment result base on this URL.\n- **paymentAmount** describes the amount of 100 USD to be collected by Wallet from user account for this payment.\n- **extraParams,** only includes 1 key - [**ORDER**](https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/vs3pkf#pKKxn) now.  ORDER describes the order details of the purchase of the 100 USD merchandise by the  user at the  merchant. Such as Merchant, Buyer, Goods, etc are included in order . The information in the Order is only used to  display user's payment result page and transactions history,  regulation reporting, etc. It will not make use of the amount in the order for fund operation.\n- **extendInfo,** includes key - **customerBelongsTo** the e-wallet that the customer uses. Corresponding to the field 'siteName' that obtained from the API 'my.getSiteInfo', in the Mini Program scenario this is mandatory.\n\n### Response\n\ncopy\n\n```json\n{\n \"result\": {\n    \"resultCode\":\"ACCEPT\",\n    \"resultStatus\":\"A\",\n    \"resultMessage\":\"accept\"\n },\n \"paymentId\": \"string\",\n \"actionForm\":{\n    \"actionFormType\":\"REDIRECTION\",\n    \"redirectionUrl\":\"http://www.merchant.com/cashier?orderId=xxxxxxx\"\n }\n}\n```\n\n- **result.resultStatus ==A** shows that the  payment is accept success. After user finish payment in cashier page, payment will change to success.\n- **paymentId** is generated by Wallet, uniquely identifies the payment.\n- **actionForm** will return cashier  page url to merchant/partner,  after merchant/partner received accept result, will redirect to this URL.",
  "date": "2022-07-03",
  "source": "https://miniprogram.gcash.com/docs/miniprogram_gcash/mpdev/v1_pay",
  "path": "miniprogram_gcash",
  "type": "miniprogram",
  "filename": "miniprogram.gcash.com_docs_miniprogram_gcash_mpdev_v1_pay.json"
}